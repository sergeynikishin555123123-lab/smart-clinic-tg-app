import { Telegraf, Context } from 'telegraf';

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫
interface ButtonConfig {
  text: string;
  reply: string;
}

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ (–ø–æ–∫–∞ —Ö—Ä–∞–Ω–∏–º –≤ –ø–∞–º—è—Ç–∏, –ø–æ—Ç–æ–º –ø–µ—Ä–µ–Ω–µ—Å–µ–º –≤ –ë–î)
let buttonConfigs: Record<string, ButtonConfig> = {
  'navigation': {
    text: 'üì± –ù–∞–≤–∏–≥–∞—Ü–∏—è',
    reply: '–û—Ç–∫—Ä—ã–≤–∞—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é...'
  },
  'promotions': {
    text: 'üéÅ –ê–∫—Ü–∏–∏',
    reply: 'üéÅ –†–∞–∑–¥–µ–ª –∞–∫—Ü–∏–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è!'
  },
  'support': {
    text: 'üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞',
    reply: 'üí¨ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –∞–∫–∞–¥–µ–º–∏–∏: @academy_anb\n‚è∞ –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: –ü–ù-–ü–¢ —Å 11:00 –¥–æ 19:00'
  }
};

// –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤ (–ø–æ–∫–∞ —Ö–∞—Ä–¥–∫–æ–¥, –ø–æ—Ç–æ–º –∏–∑ –ë–î)
const ADMIN_IDS = [898508164]; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à Telegram ID

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞
function isAdmin(ctx: Context): boolean {
  return ADMIN_IDS.includes(ctx.from?.id || 0);
}

// –ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
export function setupAdminPanel(bot: Telegraf) {
  // –ö–æ–º–∞–Ω–¥–∞ /admin - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
  bot.command('admin', async (ctx) => {
    if (!isAdmin(ctx)) {
      await ctx.reply('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏');
      return;
    }

    await ctx.reply('üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', {
      reply_markup: {
        keyboard: [
          ['üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏'],
          ['üì¢ –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É', 'üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏'],
          ['üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é']
        ],
        resize_keyboard: true
      }
    });
  });

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
  bot.hears('‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏', async (ctx) => {
    if (!isAdmin(ctx)) return;

    let buttonsText = 'üìã –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–Ω–æ–ø–æ–∫:\n\n';
    Object.entries(buttonConfigs).forEach(([key, config]) => {
      buttonsText += `üîπ ${config.text}\n–û—Ç–≤–µ—Ç: ${config.reply.substring(0, 50)}...\n\n`;
    });

    await ctx.reply(buttonsText, {
      reply_markup: {
        inline_keyboard: [
          [
            { text: '‚úèÔ∏è –ù–∞–≤–∏–≥–∞—Ü–∏—è', callback_data: 'edit_navigation' },
            { text: '‚úèÔ∏è –ê–∫—Ü–∏–∏', callback_data: 'edit_promotions' }
          ],
          [
            { text: '‚úèÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞', callback_data: 'edit_support' }
          ]
        ]
      }
    });
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  bot.action(/edit_(.+)/, async (ctx) => {
    if (!isAdmin(ctx)) return;

    const buttonType = ctx.match[1];
    const config = buttonConfigs[buttonType];

    await ctx.editMessageText(
      `‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏: ${config.text}\n\n` +
      `–¢–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç: ${config.reply}\n\n` +
      `–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:`,
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: '‚ùå –û—Ç–º–µ–Ω–∞', callback_data: 'cancel_edit' }]
          ]
        }
      }
    );

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    (ctx as any).session = { editing: buttonType };
  });

  // –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  bot.action('cancel_edit', async (ctx) => {
    await ctx.editMessageText('‚ùå –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  bot.on('text', async (ctx) => {
    if (!isAdmin(ctx)) return;

    const session = (ctx as any).session;
    if (session && session.editing) {
      const buttonType = session.editing;
      const newReply = ctx.message.text;

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
      buttonConfigs[buttonType].reply = newReply;

      await ctx.reply(`‚úÖ –û—Ç–≤–µ—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ "${buttonConfigs[buttonType].text}" –æ–±–Ω–æ–≤–ª–µ–Ω!`);
      
      // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
      (ctx as any).session = null;
    }
  });

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  bot.hears('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', async (ctx) => {
    if (!isAdmin(ctx)) return;

    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ –ë–î
    await ctx.reply(
      'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:\n\n' +
      'üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 150\n' +
      '‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è: 25\n' +
      'üì± –û—Ç–∫—Ä—ã—Ç–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: 45\n' +
      'üí¨ –°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏: 12\n\n' +
      '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏'
    );
  });

  // –†–∞—Å—Å—ã–ª–∫–∞
  bot.hears('üì¢ –°–¥–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É', async (ctx) => {
    if (!isAdmin(ctx)) return;

    await ctx.reply(
      'üì¢ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏\n\n' +
      '–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:',
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: '‚ùå –û—Ç–º–µ–Ω–∞', callback_data: 'cancel_broadcast' }]
          ]
        }
      }
    );

    (ctx as any).session = { broadcasting: true };
  });

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  bot.hears('üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏', async (ctx) => {
    if (!isAdmin(ctx)) return;

    await ctx.reply(
      'üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏\n\n' +
      '–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...\n' +
      '–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç:\n' +
      '‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n' +
      '‚Ä¢ –ò–∑–º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø–æ–¥–ø–∏—Å–æ–∫\n' +
      '‚Ä¢ –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n' +
      '‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'
    );
  });

  // –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
  bot.hears('üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', async (ctx) => {
    await ctx.reply('–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é...', {
      reply_markup: {
        keyboard: [
          ['üì± –ù–∞–≤–∏–≥–∞—Ü–∏—è', 'üéÅ –ê–∫—Ü–∏–∏'],
          ['‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å', 'üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞']
        ],
        resize_keyboard: true
      }
    });
  });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫
export function getButtonConfig(buttonType: string): ButtonConfig {
  return buttonConfigs[buttonType] || { text: '–ö–Ω–æ–ø–∫–∞', reply: '–û—Ç–≤–µ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω' };
}
